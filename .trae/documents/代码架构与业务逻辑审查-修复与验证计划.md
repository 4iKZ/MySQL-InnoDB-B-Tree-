## 对你补充清单的判断（是否存在）

### ✅ 确认存在
1. **删除同步问题（高）**：`handleDeleteRow` 里对 `pkTree/secTree` 直接调用 `delete`，但随后 `setData` 触发 `useEffect` 立刻用 `fromRows` 重建，两次操作语义冲突且前者基本被覆盖，并且还包含“直接变异 state 对象”的风险。[App.tsx:L50-L56](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/App.tsx#L50-L56)、[App.tsx:L70-L82](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/App.tsx#L70-L82)
2. **类型系统不完整（中）**：`BPlusTreeNode` 类型没有 `parent`，但实现中通过 `@ts-ignore` 注入并依赖它做删除与下溢处理。[bPlusTreeLogic.ts:L24-L36](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/utils/bPlusTreeLogic.ts#L24-L36)、[types.ts:L8-L15](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/types.ts#L8-L15)
3. **性能：数据变动完全重建树（中）**：每次 `data` 变更都重建两棵树，数据量上去会显著变慢。[App.tsx:L50-L56](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/App.tsx#L50-L56)
4. **UI alert 阻塞（低）**：多处 `alert`，会阻塞 UI 与影响体验。[App.tsx:L58-L67](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/App.tsx#L58-L67)、[App.tsx:L84-L90](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/App.tsx#L84-L90)、[App.tsx:L132-L139](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/App.tsx#L132-L139)
5. **全局变量 nodeIdCounter（低）**：重建树时 id 持续增长，影响可测试性与调试复现。[bPlusTreeLogic.ts:L7-L9](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/utils/bPlusTreeLogic.ts#L7-L9)

### ⚠️ 需要更正：borrowFromRight “逻辑错误”并不成立（在当前 ORDER=4、MIN_KEYS=1 前提下）
- 叶子借用右兄弟前置条件是 `rightSibling.keys.length > MIN_KEYS`（即至少 2 个 key）。借走 1 个后，`rightSibling.keys[0]` 仍然存在，因此 `parent.keys[childIdx] = rightSibling.keys[0]` 能正确更新为“右孩子的新最小 key”（与当前查找路由 `key >= separator` 走右侧一致）。[bPlusTreeLogic.ts:L231-L236](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/utils/bPlusTreeLogic.ts#L231-L236)、[bPlusTreeLogic.ts:L288-L297](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/utils/bPlusTreeLogic.ts#L288-L297)
- 我会把这一点变成**可验证的测试/不变量检查**：如果将来调整 ORDER/MIN_KEYS 或实现细节，测试会第一时间报红，而不是凭直觉改错。

## 额外发现（并入同一份计划）

1. **严重：潜在 Key 泄露风险（高/严重）**：Vite `define` 把 `GEMINI_API_KEY` 注入到前端构建产物，一旦 `.env.local` 被填入真实 Key，会直接暴露到浏览器端 JS 中。[vite.config.ts:L13-L16](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/vite.config.ts#L13-L16)、[.env.local](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/.env.local)
2. **严重：DataTable render 时原地 sort 变异 state（高）**：`data.sort(...)` 直接修改 App 的 `data` 数组，破坏“按插入顺序观察分裂”的产品目标，还可能触发难以解释的 UI 行为。[DataTable.tsx:L92-L108](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/components/DataTable.tsx#L92-L108)、[bPlusTreeLogic.ts:L364-L368](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/utils/bPlusTreeLogic.ts#L364-L368)
3. **高风险：二级索引重复 key 跨叶后查找/删除不一致（高）**：当前重复 key 策略会在分裂后使相同 key 分布到左右叶，查找路由“等于 separator 走右侧”会导致落到错误叶，删除可能失败或删不干净。[bPlusTreeLogic.ts:L63-L75](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/utils/bPlusTreeLogic.ts#L63-L75)、[bPlusTreeLogic.ts:L129-L147](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/utils/bPlusTreeLogic.ts#L129-L147)、[bPlusTreeLogic.ts:L171-L215](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/utils/bPlusTreeLogic.ts#L171-L215)
4. **中风险：叶子链可视化未使用真实 next**，会掩盖算法层 next 维护错误。[TreeVisualizer.tsx:L74-L83](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/components/TreeVisualizer.tsx#L74-L83)
5. **构建/运行一致性问题（低/中）**：index.html 引用了不存在的 `/index.css`，且混用 importmap/CDN 与 Vite 打包依赖，存在部署路径不一致风险。[index.html:L29-L46](file:///d:/trae-cn/workspace/innodb-b%2B-tree-viz/index.html#L29-L46)

## 合并后的修复与验证计划（按优先级）

### P0（立即修复/先把风险与确定性 bug 清掉）
1. 取消前端 bundle 中的 Key 注入路径，统一 Key 来源策略（仅 UI/LocalStorage；或改为服务端代理，但二者不要混用）。
2. 修复 DataTable 的原地 sort（改为拷贝排序或在展示层排序，不触碰 state 本体）。
3. 统一删除语义：选择“树完全由 data 派生”或“树为独立状态演示算法”，并按所选语义重写 `handleDeleteRow` 与树更新方式，消除 state 变异与重复计算。

### P1（核心算法正确性与类型安全）
1. 把 `parent` 纳入类型系统（或改为不依赖 parent 的删除实现），移除 @ts-ignore。
2. 明确二级索引重复 key 的策略并实现一致行为：
   - 允许重复：需要修正路由/分裂/删除（例如重复聚合到同一个 key 的 `data[i]`，避免“跨叶重复”；或删除时沿相邻叶扫描）。
   - 不允许重复：在 UI/业务层 enforce。
3. 补全删除后 separator 更新与深层下溢稳定性（重点是“正确性可被测试验证”，而不是单纯加递归深度上限）。

### P2（可视化一致性与体验）
1. 叶子链渲染基于真实 `next`，并加一致性校验（发现 next 异常时可在 UI 或 console 给出提示）。
2. 优化 d3 zoom/auto-fit effect 的绑定与清理，避免多次绑定造成交互异常。
3. 清理构建入口问题：处理 `/index.css` 引用与 importmap 依赖来源混乱。
4. 将 `alert` 替换为非阻塞提示（Toast/内联提示），并复用现有 UI 风格。

### 测试与动态验证（退出计划模式后执行）
1. 运行现有 Vitest。
2. 新增/强化单测：
   - 二级索引重复 key 强制分裂后查找/删除用例（当前最容易暴露一致性问题）。
   - 借用/合并后不变量校验（把 borrowFromRight 的正确性做成“会自动验证”的测试）。
   - 删除后 separator 更新正确性与叶子 next 链一致性。
3. 新增 AIService 单测（mock fetch 与 @google/genai），覆盖错误分类与回退消息。
4. 交互回归：乱序插入分裂、随机生成大量数据、删除、点击叶子触发 AI。

## 最终交付
- 一份“问题ID-严重性-根因-修复方案-影响模块-验证方式”的审查报告（包含代码定位链接）。
- 一组按 P0/P1/P2 拆分的变更集，便于你逐项审阅与回滚。
